---
- name: install policycoreutils
  package:
    name: policycoreutils-python
    state: present
  become: yes

- name: create jekyll build folders
  file:
    path: "{{ jekyll_build_path }}"
    owner: "{{ web_user }}"
    group: "{{ web_user }}"
    state: directory
  become: yes

- name: create git folders
  file:
    path: "{{ repo_path }}"
    owner: "{{ web_user }}"
    group: "{{ web_user }}"
    state: directory
  become: yes

# this has to be done as sudo then chowned in the next step otherwise ansible complains
- name: initialize empty git repo
  shell:
     cmd: "git init --bare {{ repo_path }}/{{ blog_name }}.git"
  args:
     creates: "{{ repo_path }}/{{ blog_name }}.git/HEAD"
  become: yes

- name: change owner of git repo
  file:
    path: "{{ repo_path }}/{{ blog_name }}.git"
    owner: "{{ web_user }}"
    group: "{{ web_user }}"
    recurse: yes
  become: yes

- name: setup post-deply hook
  template:
    dest: "{{ repo_path }}/{{ blog_name }}.git/hooks/post-receive"
    src: templates/git-post-receive.j2
    owner: "{{ web_user }}"
    group: "{{ web_user }}"

- name: remove default nginx files
  file:
    path: /usr/share/nginx/html
    state: absent
  become: yes

- name: recreate nginx folder
  file:
    path: /usr/share/nginx/html
    state: directory
    owner: "{{ web_user }}"
    group: "{{ web_user }}"
  become: yes

- name: link jekyll build folder to nginx
  file:
    dest: "/usr/share/nginx/html"
    src: "{{ jekyll_build_path }}/_site/"
    state: link
    owner: "{{ web_user }}"
    group: "{{ web_user }}"
    force: yes
  become: yes

- name: update SELinux context for site directory
  sefcontext:
    target: "{{ item }}"
    setype: httpd_sys_content_t
    state: present
  become: yes
  with_items:
    - "{{ jekyll_build_path }}/_site"
    - /usr/share/nginx/html

- name: start nginx
  service:
    name: nginx
    state: started
  become: yes
